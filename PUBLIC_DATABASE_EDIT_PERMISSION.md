# 公共数据库编辑权限功能

## 功能概述

管理员现在可以通过用户管理系统，灵活地给特定用户开放公共数据库的编辑权限。

## 主要变更

### 1. 数据库层面
- 在 `user_permissions` 表中新增 `can_edit_public_database` 字段（布尔类型，默认 false）
- 更新 `public_reference_images` 表的 RLS 策略，检查此权限字段
- 管理员始终拥有编辑权限

### 2. 用户管理界面
- 在管理员控制台的用户管理面板中，新增"公共库编辑"列
- 管理员可以通过复选框开启/关闭用户的编辑权限
- 权限状态清晰显示："允许"或"禁止"

### 3. 权限控制范围
此权限控制以下操作：
- 上传公共参考图片（包括竞品图库）
- 删除公共参考图片
- 编辑公共参考图片信息
- 通过浏览器扩展上传图片

### 4. Edge Function 安全增强
- `competitor-image-upload` Edge Function 现在会验证用户权限
- 只有管理员或拥有编辑权限的用户才能上传图片
- 未授权用户会收到明确的权限不足提示

## 使用方法

### 管理员操作步骤

1. 登录管理员账户
2. 进入"管理员控制台"
3. 选择"用户管理"标签页
4. 在用户列表中找到目标用户
5. 点击"编辑权限"按钮（蓝色铅笔图标）
6. 勾选"公共库编辑"选项中的"允许"复选框
7. 点击"保存"按钮（绿色勾号图标）

### 用户访问入口

拥有编辑权限的用户可以通过以下方式访问公共图库管理：

1. 点击右上角用户头像，进入"用户中心"
2. 在用户中心页面顶部，会看到"公共图库管理"按钮（紫粉渐变色）
3. 点击该按钮即可进入公共参考图管理界面
4. 在管理界面中可以：
   - 添加新产品
   - 上传产品图片
   - 编辑产品信息
   - 删除图片
   - 管理产品规格
5. 点击左上角的"返回"按钮可回到用户中心

### 用户体验

**有权限的用户：**
- 在用户中心会看到"公共图库管理"按钮
- 点击后可以访问完整的公共参考图管理界面
- 可以上传、编辑、删除公共参考图片
- 可以通过浏览器扩展上传竞品图片
- 所有操作正常执行
- 在应用访问权限面板中显示"公共数据库编辑：允许"

**无权限的用户：**
- 用户中心不会显示"公共图库管理"按钮
- 仍然可以查看和使用所有公共参考图片
- 尝试通过浏览器扩展上传时会收到权限不足提示
- 在应用访问权限面板中显示"公共数据库编辑：禁止"

## 技术实现

### 权限检查函数
```typescript
// 前端检查
import { userService } from './services/userService';

const canEdit = await userService.canEditPublicDatabase();
if (canEdit) {
  // 显示编辑按钮
}
```

### RLS 策略
数据库级别的安全保障：
- 查看：所有启用用户
- 编辑：管理员 + 有编辑权限的用户

## 安全说明

1. 权限验证在多个层面执行：
   - 数据库 RLS 策略（最终防线）
   - Edge Function 层（API 网关）
   - 前端界面（用户体验）

2. 管理员权限优先级最高，始终拥有完整权限

3. 普通用户的查看权限不受影响

## 注意事项

- 修改权限后立即生效，无需用户重新登录
- 建议定期审查用户权限，确保权限分配合理
- 可以随时收回用户的编辑权限
