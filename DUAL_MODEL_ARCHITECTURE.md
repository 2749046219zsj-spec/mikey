# 双语言模型架构说明

## 概述

系统现在支持两个完全独立的语言模型，分别用于不同的功能：

1. **普通模式** - 使用主界面的Gemini语言模型进行图像生成
2. **专业模式** - 使用客服助手的定制Gemini语言模型进行提示词优化

## 架构设计

### 两个独立的Chat Hook

#### 1. useChat (主界面)
- 位置: `src/hooks/useChat.ts`
- 用途: 直接进行AI图像生成
- 特点:
  - 无系统提示词
  - 支持批量队列处理
  - 每次请求独立，不保留对话历史

#### 2. useWidgetChat (客服助手)
- 位置: `src/hooks/useWidgetChat.ts`
- 用途: 提示词识别和优化
- 特点:
  - 包含专业的系统提示词
  - 专注于提示词提取和优化
  - 保留完整对话历史
  - 输出格式化的编号列表

### 系统提示词

客服助手使用的系统提示词（位于useWidgetChat.ts第47-74行）：

```
你是一个专业的提示词识别和优化专家。你的任务是从给定文本中快速识别并优化提示词。

**任务要求：**
1. 从输入文本中识别潜在的提示词段落
2. 筛选条件：提示词长度必须大于20个字符
3. 对识别出的提示词进行优化改进
4. 上下文分析：考虑前后文的完整性，确保提示词完整

**输出格式（支持以下任意一种）：**
格式1：编号列表（推荐，最常用）
1. 优化后的提示词内容1
2. 优化后的提示词内容2

格式2：双引号编号列表
1. "优化后的提示词内容1"
2. "优化后的提示词内容2"

**重要规则：**
- 每个提示词必须长度大于20个字符
- 保持提示词的完整性，不要截断
- 如果用户输入已经是编号列表格式，直接优化输出即可
- 每行一个提示词，确保格式清晰
```

## 用户工作流程

### 普通模式流程
1. 用户输入文本/上传图片
2. 直接调用Gemini API生成图像
3. 每次扣除一次绘图次数

### 专业模式流程
1. 用户使用工具栏选择产品/风格/工艺
2. 或直接输入文本
3. 调用客服助手的语言模型进行提示词优化
4. AI返回优化后的提示词列表
5. 用户点击"发送到生成"按钮
6. 选择参考图
7. 系统自动批量扣除绘图次数
8. 调用主界面的生成功能进行批量生成

## 模式切换

### 触发条件
- 只有开启客服助手权限的用户才能看到专业模式
- 权限字段: `user.permissions.chat_assistant_enabled`

### 切换效果
- 消息历史完全独立
- 清空对话按钮对应不同的消息流
- 输入框样式和placeholder不同
- 专业模式显示工具栏

## 关键组件

### AppContent.tsx
- 管理两个独立的chat状态
- 根据currentMode切换显示的消息和loading状态
- 处理提示词提取和发送到生成的逻辑

### ChatHeader.tsx
- 显示模式切换按钮
- 根据模式显示不同的文本

### ChatContainer.tsx
- 根据isProfessionalMode显示AssistantMessageActions
- 支持从AI消息中提取提示词

### AssistantMessageActions.tsx
- 提取AI回复中的提示词
- 显示"发送到生成"按钮
- 跟踪已发送的消息

### ProfessionalToolbar.tsx
- 专业模式的工具栏
- 包含产品、风格、工艺等选择器

## 提示词提取逻辑

系统支持多种格式的提示词识别：

1. 双引号编号列表: `1. "提示词内容"`
2. 编号列表: `1. 提示词内容`
3. 中文顿号: `1、提示词内容`

提取函数位于：
- `src/AppContent.tsx` - extractPrompts函数
- `src/components/AssistantMessageActions.tsx` - extractPrompts函数

## 数据流

```
[普通模式]
用户输入 → useChat → Gemini API → 图像生成 → 显示结果

[专业模式]
用户输入 → useWidgetChat → Gemini API (带系统提示词) → 优化提示词
→ 用户点击发送 → 选择参考图 → useChat → 批量图像生成
```

## 技术要点

1. **状态隔离**: 两个模式的消息完全独立，互不影响
2. **权限控制**: 专业模式需要特定权限
3. **批量处理**: 专业模式支持自动扣除多次绘图次数
4. **提示词格式**: 使用 `**提示词**` 格式标记批量提示词

## 未来扩展

- 可以为专业模式添加更多定制化的系统提示词
- 可以支持多个不同的助手模型（设计、营销、文案等）
- 可以添加模型参数调整（温度、top_p等）
