# 用户管理系统设置说明

## 系统概述

已成功实现完整的用户管理系统，包含以下功能：

### 用户端功能
- **用户注册/登录**: 使用邮箱和密码进行注册和登录
- **用户仪表板**: 显示剩余绘图次数、客服助手状态、访问权限级别
- **权限控制**: 新用户默认5次绘图机会，仅可访问基础功能
- **密码找回**: 通过邮箱重置密码

### 管理员功能
- **用户管理**: 查看所有用户列表
- **用户编辑**: 修改用户信息和状态
- **权限配置**:
  - 设置绘图次数限制（总数和剩余次数）
  - 开启/关闭客服助手功能
  - 配置应用访问级别（基础/完整）
- **账户控制**: 启用/停用用户账户
- **使用统计**: 查看所有用户的活动统计

## 技术实现

- **前端**: React + TypeScript + Tailwind CSS
- **后端**: Supabase (PostgreSQL + Auth)
- **数据库表**:
  - `user_profiles`: 用户基本信息
  - `user_permissions`: 用户权限配置
  - `usage_logs`: 使用记录追踪
- **安全**: Row Level Security (RLS) 策略确保数据安全

## 创建管理员账户

由于数据库已设置，您需要创建第一个管理员账户。有两种方法：

### 方法1: 通过 Supabase Dashboard

1. 登录您的 Supabase 项目控制台
2. 进入 SQL Editor
3. 执行以下 SQL 语句（替换为您想要的管理员邮箱）:

```sql
-- 首先在应用中注册一个普通账户
-- 然后运行以下 SQL 将该用户提升为管理员

UPDATE user_profiles
SET is_admin = true
WHERE email = 'admin@example.com';
```

### 方法2: 通过应用程序

1. 在应用中注册一个新账户
2. 在 Supabase Dashboard 的 SQL Editor 中运行上述 SQL
3. 重新登录以获取管理员权限

## 使用说明

### 普通用户流程
1. 在登录页面点击"立即注册"
2. 填写用户名、邮箱和密码
3. 注册成功后自动获得:
   - 5次绘图机会
   - 基础访问权限
   - 客服助手默认关闭
4. 登录后可在右上角查看剩余绘图次数
5. 点击"我的账户"查看详细权限信息

### 管理员流程
1. 使用管理员账户登录
2. 进入"我的账户"页面
3. 点击"管理后台"按钮
4. 在管理控制台中:
   - **用户管理**: 查看和编辑所有用户
   - **使用统计**: 查看系统使用情况
5. 编辑用户权限:
   - 点击"编辑"按钮
   - 修改绘图次数、客服助手状态、访问级别
   - 点击"保存"按钮
6. 启用/停用用户:
   - 点击"启用"或"停用"按钮
   - 被停用的用户无法登录系统

## 权限说明

### 绘图次数
- `draw_limit`: 总绘图次数限制
- `remaining_draws`: 剩余可用次数
- 每次生成图片会自动扣除1次
- 当次数为0时，用户无法继续生成图片

### 客服助手
- `chat_assistant_enabled`: 布尔值
- 开启后用户可以使用客服助手功能
- 关闭后客服助手窗口不显示

### 访问级别
- `basic`: 基础访问，仅限"图1部分应用"
- `full`: 完整访问，可使用所有功能

## 数据安全

系统已实现以下安全措施：
- 密码使用 Supabase Auth 加密存储
- Row Level Security (RLS) 确保用户只能访问自己的数据
- 管理员通过特殊策略访问所有数据
- 所有数据库操作都有权限验证
- 使用日志自动记录用户活动

## 故障排除

### 用户无法登录
- 检查邮箱和密码是否正确
- 确认账户未被停用
- 查看 Supabase Auth 日志

### 管理员功能不显示
- 确认用户的 `is_admin` 字段为 `true`
- 重新登录以刷新用户权限

### 权限修改不生效
- 刷新页面或重新登录
- 检查 RLS 策略是否正确设置

## 后续扩展建议

1. **邮箱验证**: 启用 Supabase 邮箱确认功能
2. **批量操作**: 添加批量修改用户权限功能
3. **数据导出**: 实现使用统计的导出功能
4. **通知系统**: 当权限变更时通知用户
5. **日志筛选**: 添加日期范围和类型筛选
6. **用户分组**: 创建用户组并批量分配权限
